<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Cliente no Agendor</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 15px;
      margin: 0;
      color: #333;
      font-size: 14px;
    }
    h2 {
      font-size: 16px;
      margin-top: 0;
      color: #0073e6;
      border-bottom: 2px solid #f2f2f2;
      padding-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #e1e1e1;
      text-align: left;
      word-break: break-all;
    }
    th {
      background-color: #f8f8f8;
      width: 30%;
      font-weight: 600;
    }
    #status {
      margin-top: 20px;
    }
    .erro {
      color: #d9534f;
    }
    .not-found {
      color: #8a6d3b;
    }
  </style>
</head>
<body>
  <h2>Cliente no Agendor</h2>
  <div id="status">Buscando dados...</div>
  <div id="resultado"></div>

  <script>
    function getEmailFromUrl() {
      var params = new URLSearchParams(window.location.search);
      return params.get('email');
    }

    function buscarContato(email) {
      var statusDiv = document.getElementById('status');
      var resultadoDiv = document.getElementById('resultado');
      
      var protocol = 'https';
      var domain = 'agendor-smartplug-api.onrender.com';
      var path = '/api/contato?email=' + encodeURIComponent(email);
      var apiUrl = protocol + '://' + domain + path;

      fetch(apiUrl)
        .then(function(response) {
          if (!response.ok) { throw response; }
          return response.json();
        })
        .then(function(data) {
          statusDiv.style.display = 'none';
          
          // --- INÍCIO DA MUDANÇA ---
          var orgName = data.organization ? data.organization.name : 'N/A';
          var phone = data.contact ? (data.contact.whatsapp || data.contact.mobile || 'N/A') : 'N/A';
          var ownerName = data.ownerUser ? data.ownerUser.name : 'N/A'; // Pega o nome do vendedor
          // --- FIM DA MUDANÇA ---

          resultadoDiv.innerHTML =
            '<table>' +
              '<tr><th>Nome</th><td>' + (data.name || 'N/A') + '</td></tr>' +
              '<tr><th>Email</th><td>' + (data.email || 'N/A') + '</td></tr>' +
              '<tr><th>Telefone</th><td>' + phone + '</td></tr>' +
              '<tr><th>Empresa</th><td>' + orgName + '</td></tr>' +
              '<tr><th>Cargo</th><td>' + (data.role || 'N/A') + '</td></tr>' +
              '<tr><th>Vendedor</th><td>' + ownerName + '</td></tr>' + // Adiciona a nova linha da tabela
            '</table>';
        })
        .catch(function(errorResponse) {
           statusDiv.textContent = 'Erro ao buscar dados.';
           statusDiv.className = 'erro';
           if (errorResponse.json) {
              errorResponse.json().then(function(errorData) {
                resultadoDiv.innerHTML = '<p class="erro">' + (errorData.error || 'Não encontrado.') + '</p>';
              });
           }
        });
    }

    function init() {
      var emailFromUrl = getEmailFromUrl();
      
      if (emailFromUrl && emailFromUrl.indexOf('@') > -1) {
        buscarContato(emailFromUrl);
      } else {
        var statusDiv = document.getElementById('status');
        statusDiv.textContent = 'Email do cliente não disponível na URL.';
        statusDiv.className = 'not-found';
      }
    }

    window.onload = init;
  </script>
</body>
</html>
