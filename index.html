<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cliente no Agendor</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:15px;margin:0;color:#333;font-size:14px}
    h2,h3{font-size:16px;margin-top:0;color:#0073e6;border-bottom:2px solid #f2f2f2;padding-bottom:10px}
    h3{font-size:15px;color:#333;border-color:#eee}
    table{width:100%;border-collapse:collapse;margin-top:15px}
    th,td{padding:8px;border:1px solid #e1e1e1;text-align:left;word-break:break-all}
    th{background-color:#f8f8f8;width:30%;font-weight:600}
    .hidden{display:none}
    .form-group{margin-bottom:10px}
    .form-group label{display:block;margin-bottom:5px;font-weight:600}
    .form-group input, .form-group select, .form-group textarea{width:95%;padding:8px;border:1px solid #ccc;border-radius:4px; font-family: sans-serif;}
    .btn{background-color:#0073e6;color:white;padding:10px 15px;border:none;border-radius:4px;cursor:pointer;font-size:14px;margin-right:5px;}
    .btn-secondary{background-color:#6c757d;}
    .btn:hover{opacity:0.9}
    .btn:disabled{background-color:#ccc;cursor:not-allowed}
    .feedback{font-weight:bold;margin-top:10px;padding:8px;border-radius:4px}
    .erro{color:#d9534f;background-color:#f8d7da;}
    .success{color:#155724;background-color:#d4edda;}
  </style>
</head>
<body>
  <!-- View de Carregamento -->
  <div id="loader-view">
    <h2>Cliente no Agendor</h2>
    <p>A procurar dados...</p>
  </div>

  <!-- View Principal (Exibição ou Ações) -->
  <div id="main-view" class="hidden">
    <h2>
      Cliente no Agendor
      <button id="reload-btn" class="btn btn-secondary" style="float:right; padding: 5px 10px; font-size: 12px;">Recarregar</button>
    </h2>
    <div id="content"></div>
  </div>

  <!-- View para Criar Empresa -->
  <div id="create-company-view" class="hidden">
    <h3>Cadastrar Nova Empresa</h3>
    <form id="company-form">
        <div class="form-group">
            <label for="company-name">Nome da Empresa</label>
            <input type="text" id="company-name" required>
        </div>
        <div class="form-group">
            <label for="company-cnpj">CNPJ (Opcional)</label>
            <input type="text" id="company-cnpj">
        </div>
        <div class="form-group">
            <label for="company-sector">Setor</label>
            <select id="company-sector">
                <option value="">Selecione um setor</option>
                <option value="Meios de Pagamento">Meios de Pagamento</option>
                <option value="Monitoramento">Monitoramento</option>
                <option value="Rastreamento">Rastreamento</option>
                <option value="Segurança Eletrônica">Segurança Eletrônica</option>
                <option value="Telemetria">Telemetria</option>
            </select>
        </div>
        <div class="form-group">
            <label for="company-category">Categoria</label>
            <select id="company-category">
                <option value="">Selecione uma categoria</option>
                <option value="Bloqueado">Bloqueado</option>
                <option value="Cliente ativo">Cliente ativo</option>
                <option value="Cliente inativo">Cliente inativo</option>
                <option value="Concorrente">Concorrente</option>
                <option value="Fornecedor">Fornecedor</option>
                <option value="Lead">Lead</option>
                <option value="Parceiro">Parceiro</option>
            </select>
        </div>
        <div class="form-group">
            <label for="company-owner">Responsável</label>
            <select id="company-owner">
                <option value="daniel.martins@avatek.com.br">Daniel Martins</option>
                <option value="denise.grigorine@avatek.com.br">Denise Grigorine</option>
            </select>
        </div>
        <div class="form-group">
            <label for="company-description">Descrição</label>
            <textarea id="company-description" rows="4"></textarea>
        </div>
        <button type="submit" class="btn">Cadastrar Empresa</button>
        <button type="button" class="btn btn-secondary" onclick="showMainView()">Voltar</button>
    </form>
    <div id="company-feedback" class="feedback"></div>
  </div>

  <!-- View para Criar Pessoa -->
  <div id="create-person-view" class="hidden">
    <h3>Cadastrar Nova Pessoa</h3>
    <form id="person-form">
        <div class="form-group">
            <label for="person-name">Nome</label><input type="text" id="person-name" required>
        </div>
        <div class="form-group">
            <label for="person-email">Email</label><input type="email" id="person-email" required>
        </div>
        <div class="form-group">
            <label for="person-phone">Telefone</label><input type="text" id="person-phone">
        </div>
        <div class="form-group">
            <label for="person-company">Empresa (nome exato)</label><input type="text" id="person-company">
        </div>
        <div class="form-group">
            <label for="person-owner">Responsável</label>
            <select id="person-owner">
                <option value="daniel.martins@avatek.com.br">Daniel Martins</option>
                <option value="denise.grigorine@avatek.com.br">Denise Grigorine</option>
            </select>
        </div>
        <button type="submit" class="btn">Cadastrar Pessoa</button>
        <button type="button" class="btn btn-secondary" onclick="showMainView()">Voltar</button>
    </form>
    <div id="person-feedback" class="feedback"></div>
  </div>

  <script>
    var API_BASE_URL = 'https://agendor-smartplug-api.onrender.com/api';
    var VIEWS = {
        loader: document.getElementById('loader-view'),
        main: document.getElementById('main-view'),
        createCompany: document.getElementById('create-company-view'),
        createPerson: document.getElementById('create-person-view'),
    };
    var mainContent = document.getElementById('content');
    var urlParams = {};
    var lastCreatedCompany = null;

    function showView(viewName) {
        Object.keys(VIEWS).forEach(function(key) { VIEWS[key].classList.add('hidden'); });
        if (VIEWS[viewName]) VIEWS[viewName].classList.remove('hidden');
    }
    function showMainView() { showView('main'); }
    function showCreateCompanyForm() { 
        document.getElementById('company-description').value = 'Inserido via API - ';
        showView('createCompany'); 
    }
    function showCreatePersonForm() { 
        document.getElementById('person-name').value = urlParams.name || '';
        document.getElementById('person-email').value = urlParams.email || '';
        showView('createPerson');
    }

    function renderContactData(data) {
        var name = data.name, email = data.email, organization = data.organization, contact = data.contact, ownerUser = data.ownerUser, role = data.role;
        
        var sector = 'N/A';
        if (organization && organization.sector) {
            sector = organization.sector.name || organization.sector;
        }
        var category = 'N/A';
        if (organization && organization.category) {
            category = organization.category.name || organization.category;
        }
        
        mainContent.innerHTML = 
            '<table>' +
                '<tr><th>Nome</th><td>' + (name || 'N/A') + '</td></tr>' +
                '<tr><th>Email</th><td>' + (email || 'N/A') + '</td></tr>' +
                '<tr><th>Telefone</th><td>' + (contact && (contact.whatsapp || contact.mobile) || 'N/A') + '</td></tr>' +
                '<tr><th>Empresa</th><td>' + (organization && organization.name || 'N/A') + '</td></tr>' +
                '<tr><th>Setor</th><td>' + sector + '</td></tr>' +
                '<tr><th>Categoria</th><td>' + category + '</td></tr>' +
                '<tr><th>Cargo</th><td>' + (role || 'N/A') + '</td></tr>' +
                '<tr><th>Vendedor</th><td>' + (ownerUser && ownerUser.name || 'N/A') + '</td></tr>' +
            '</table>';
    }
    function renderNotFound() {
        mainContent.innerHTML = 
            '<p>Cliente não encontrado no Agendor.</p>' +
            '<button class="btn" onclick="showCreateCompanyForm()">Registar Empresa</button>' +
            '<button class="btn" onclick="showCreatePersonForm()">Registar Pessoa</button>';
    }

    function fetchContact(email) {
        fetch(API_BASE_URL + '/contato?email=' + encodeURIComponent(email))
            .then(function(response) {
                showView('main');
                if (response.status === 404) {
                    renderNotFound();
                } else if (response.ok) {
                    return response.json().then(renderContactData);
                } else {
                    throw new Error('Erro na API');
                }
            })
            .catch(function(error) {
                mainContent.innerHTML = '<div class="feedback erro">Não foi possível ligar à API.</div>';
                showView('main');
            });
    }

    function handleFormSubmit(event, formType) {
        event.preventDefault();
        var form = event.target;
        var btn = form.querySelector('button[type="submit"]');
        var feedbackDiv = document.getElementById(formType + '-feedback');
        btn.disabled = true;
        feedbackDiv.className = 'feedback';
        feedbackDiv.textContent = 'A guardar...';

        var endpoint, payload;
        if (formType === 'company') {
            endpoint = API_BASE_URL + '/criar-empresa';
            payload = { 
                name: document.getElementById('company-name').value,
                cnpj: document.getElementById('company-cnpj').value,
                sector: document.getElementById('company-sector').value,
                category: document.getElementById('company-category').value,
                ownerUserEmail: document.getElementById('company-owner').value,
                description: document.getElementById('company-description').value
            };
        } else {
            endpoint = API_BASE_URL + '/criar-contato';
            payload = {
                name: document.getElementById('person-name').value,
                email: document.getElementById('person-email').value,
                phone: document.getElementById('person-phone').value,
                organizationName: document.getElementById('person-company').value,
                ownerUserEmail: document.getElementById('person-owner').value
            };
        }

        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(function(response) {
            return response.json().then(function(data) {
                if (!response.ok) throw new Error(data.error || 'Erro desconhecido');
                return data;
            });
        })
        .then(function(data) {
            feedbackDiv.className = 'feedback success';
            feedbackDiv.textContent = (formType === 'company' ? 'Empresa' : 'Pessoa') + ' "' + data.name + '" guardada com sucesso!';
            form.reset();
            if (formType === 'company') {
                lastCreatedCompany = data;
                setTimeout(function() {
                    document.getElementById('person-company').value = data.name;
                    showCreatePersonForm();
                }, 1500);
            }
        })
        .catch(function(error) {
            feedbackDiv.className = 'feedback erro';
            feedbackDiv.textContent = 'Erro: ' + error.message;
        })
        .finally(function() {
            btn.disabled = false;
        });
    }

    function getUrlParams() {
        var params = new URLSearchParams(window.location.search);
        return {
            email: params.get('email'),
            name: params.get('name')
        };
    }

    function init() {
        showView('loader');
        urlParams = getUrlParams();
        if (urlParams.email && urlParams.email.indexOf('@') > -1) {
            fetchContact(urlParams.email);
        } else {
            VIEWS.loader.innerHTML = '<p>Email do cliente não disponível.</p>';
        }
    }

    window.onload = function() {
        init();
        document.getElementById('reload-btn').addEventListener('click', init);
        document.getElementById('company-form').addEventListener('submit', function(e) { handleFormSubmit(e, 'company'); });
        document.getElementById('person-form').addEventListener('submit', function(e) { handleFormSubmit(e, 'person'); });
    };
  </script>
</body>
</html>
